<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Game.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: Game.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/// &lt;reference path="Canvas.js" />
var vastengine = vastengine || {};
var $vast = vastengine;

(function () {
    /**
     * Manages game-level components such as the currently running Controller object, routing input, and accessing assets through AssetManager instances.
     * @constructor
     */
    vastengine.Game = function () {
        this.activeController = null;
        this.activeDialog = null;
        this.state = vastengine.GameState.STOPPED;
    };

    /**
     * Enum of states that the game loop can be in (stopped or running).
     * @enum {number}
     */
    vastengine.GameState = {
        STOPPED: 0,
        RUNNING: 1
    };

    /**
     * Game-level constants. Intended to be overridden as the first step of game setup (or use these defaults).
     */
    vastengine.Game.Config = {
        fps: 60,
        canvasWidth: window.innerWidth,
        canvasHeight: window.innerHeight,
        scaleFromCenter: false,
        debugShowFPS: true
    };

    /**
     * Sets the game state, used to pause and resume the game loop.
     * @param {GameState} state.
     */
    vastengine.Game.setState = function (state) {
        this.state = state;
    };

    /** 
     * Sets the running Controller to the given Controller object.
     */
    vastengine.Game.setActiveController = function (newActiveController) {
        this.activeController = newActiveController;
    };

    /** 
     * Returns the running Controller
     */
    vastengine.Game.getActiveController = function () {
        return this.activeController;
    };

    /**
     * Determines whether a Controller object has been assigned as the active controller.
     * @return {boolean} True if an active controller exists.
     */
    vastengine.Game.hasActiveControler = function () {
        if (this.activeController) {
            return this.activeController.view !== undefined;
        }
        return false;
    };

    /**
     * Pauses the game loop to launch the given Dialog object.
     * @param {Dialog} Dialog object to show.
     */
    vastengine.Game.setDialog = function (dialog) {
        if (dialog) {
            this.activeDialog = dialog;
            this.activeDialog.setVisible(true);
            vastengine.Game.setState(vastengine.GameState.STOPPED);
        } else {
            vastengine.Game.setState(vastengine.GameState.RUNNING);
            this.activeDialog.setVisible(false);
            this.activeDialog = null;
        }
    };

    /**
     * Initializes all game-level resources. Must be called first when setting up the game.
     */
    vastengine.Game.init = function () {
        // TODO: someday make these $vast.Images, $vast.Audio, $vast.Canvas
        vastengine.Game.Images = new vastengine.AssetManager(vastengine.AssetType.IMAGE);
        vastengine.Game.Audio = new vastengine.AssetManager(vastengine.AssetType.AUDIO);
        vastengine.Game.Canvas = new vastengine.Canvas();
    };

    /**
     * The main game loop. Keeps the game running at a fixed FPS.
     */
    vastengine.Game.run = function () {
        var fps = vastengine.Game.Config.fps;
        var fpsActual = 0;
        var stepSize = 1 / fps;
        var offset = 0;
        var previous = getTimestamp();
        vastengine.Game.state = vastengine.GameState.RUNNING;

        function getTimestamp() {
            if (window.performance && window.performance.now) {
                return window.performance.now();
            } else {
                return (new Date()).getTime();
            }
        }

        function stepAndDraw() {
            var current = getTimestamp();
            offset += (Math.min(1, (current - previous) / 1000));

            // still step during the offset (time difference between frames).
            while (offset > stepSize) {
                if (vastengine.Game.state === vastengine.GameState.RUNNING) {
                    if (vastengine.Game.hasActiveControler()) {
                        vastengine.Game.getActiveController().step(stepSize);
                    }
                }

                offset -= stepSize;
            }

            // draw
            if (vastengine.Game.hasActiveControler()) {
                vastengine.Game.Canvas.draw(vastengine.Game.getActiveController());
            }
            if (vastengine.Game.activeDialog) {
                if (vastengine.Game.activeDialog.isVisible()) {
                    vastengine.Game.activeDialog.draw();
                }

            }

            if (vastengine.Game.Config.debugShowFPS) {
                drawCurrentFPS();
            }

            previous = current;
            requestAnimationFrame(stepAndDraw);
        }

        requestAnimationFrame(stepAndDraw);
    };

    function drawCurrentFPS() {
        vastengine.Game.Canvas.drawElement(function (context) {
            context.save();
            context.fillStyle = "White";
            context.font = "normal 16pt Arial";

            context.fillText(vastengine.Game.getCurrentFPS() + " fps", 64, 96);

            context.restore();
        });
        

    }

    // this is awesome: http://stackoverflow.com/questions/8279729/calculate-fps-in-canvas-using-requestanimationframe
    vastengine.Game.getCurrentFPS = (function () {
        var lastLoop = (new Date()).getMilliseconds();
        var count = 1;
        var fps = 0;

        return function () {
            var currentLoop = (new Date()).getMilliseconds();
            if (lastLoop > currentLoop) {
                fps = count;
                count = 1;
            } else {
                count += 1;
            }
            lastLoop = currentLoop;
            return fps;
        };
    }());

    /**
     * For throwing exceptions by errors noted by vastengine itself.
     * @param {string} message Error message.
     */
    vastengine.Game.setError = function (message) {
        var error = "vastengine error: ";
        if (message) {
            error += message;
        }
        throw error;
    };

})();</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="vastengine.AssetManager.html">AssetManager</a></li><li><a href="vastengine.Canvas.html">Canvas</a></li><li><a href="vastengine.Controller.html">Controller</a></li><li><a href="vastengine.Dialog.html">Dialog</a></li><li><a href="vastengine.Entity.html">Entity</a></li><li><a href="vastengine.Game.html">Game</a></li><li><a href="vastengine.Input.html">Input</a></li><li><a href="vastengine.MathUtil.html">MathUtil</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Sun Mar 01 2015 13:44:46 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
